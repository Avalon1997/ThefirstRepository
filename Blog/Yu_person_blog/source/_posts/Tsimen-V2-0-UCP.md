---
title: Tsimen_V2.0_UCP
date: 2022-04-25 13:27:53
index_img: /img/Protocol.jpg
banner_img: /img/Tsimen2.0.jpg
tags:
- 原创
- 通信协议
categories: 
- Tsimen2.0
excerpt: Tsimen2.0通信协议
# hide: true
---

# <center>Tsimen2.0 通讯协议</center>


## 一、 整体介绍

Tsimen2.0 底层下位机使用 STM32F103C8T6 芯片与设备进行交互，采集数据、驱动设备，并将数据通过 RS485 通讯协议传至上位机（Raspberry），供上位机使用。

### 1. 通讯形式

本项目中，数据通讯采用标准 RS485 传输协议和 ModBus-RTU 通讯协议。

* 说明1：**RS-485仅是一个电气传输标准，描述了接口的物理层，像协议、时序、串行或并行数据以及链路全部由设计者或更高层协议定义。 RS485定义的是使用平衡（也称作差分）多点传输线的驱动器（driver）和接收器（receiver）的电气特性。**

* 说明1： **ModBus RTU（远程终端模式）是一种串行通信协议，是一种紧凑的，采用二进制表示数据的方式。RTU格式后续的命令/数据带有循环冗余校验的校验和**

![ModBus-RTU 数据格式](./Tsimen-V2-0-UCP/ModBus-RTU%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F.png)

1. 波特率： 115200
2. 地址码： 8 位二进制（例：0x01）
3. 功能码： 8 位二进制（例：读数据，0x06）
2. 数据位： 根据指令的不同，数据位有所不同
3. 校验位： 16 位二进制 CRC-16/ModBus校验码。
4. 停止位： 无。

### 2. CRC 校验码形式

1. 模式： CRC-16/ModBus
2. CRC-16 校验多项式： x<sup>16</sup>+x<sup>15</sup>+x<sup>2</sup>+1 —— 8005
3. 初始值： FFFF
4. 结果或异或值： 0000

**<font color= 'gray'><center>CRC校验程序代码在附录</center></font>**

### 3. 注意事项


## 二、 具体指令 （待定11条）

### 1. Tsimen-2000 端

Tsimen-2000 是水质光谱检测传感器，用于......  
**发送指令格式：** {1字节地址码+1字节功能码+4字节数据位+2字节CRC校验位}  
注: （ xx 是十六进制积分时间，自行设置。 HC 是 CRC 校验高位， LC 是 CRC 校验低位 ） 

**返回指令格式：** 
> 设置成功： 01 52 49 96 DC {1字节地址码+2字节数据+2字节CRC校验位}  
> 设置失败： 01 46 41 50 D2 {1字节地址码+2字节数据+2字节CRC校验位}  
> 返回数据： 不定长数据，根据指令不同数据不同  
> CRC校验失败： 01 43 52 43 45 52 04 16 {1字节地址码+5字节数据+CRC校验位}

**<font color= 'gray'><center>所有光谱仪数据均在附录显示</center></font>**

#### Ⅰ. 全局复位指令

**上位机发送：** 01 01 00 00 00 00 0A 3C  
**Tsimen-2000 端返回值：** 设置成功 01 52 49 96 DC ； 设置失败 01 46 41 50 D2 ； CRC校验失败 01 43 52 43 45 52 04 16

**响应时间：** 1.5s  
**注意：** Tsimen-2000 端上电后请等待 2~3s 后开启串口，避免因传感器端上电复位导致的信号波动。

#### Ⅱ. 读取传感器版本号

**上位机发送：** 01 02 00 00 00 00 0A 78 
**Tsimen-2000 端返回值：** 每个传感器有固定的 Version （例：TS-2000-000001） {14字节数据}

**响应时间：** 30 ms

#### Ⅲ. 设置光谱仪积分时间

**上位机发送：** 01 03 xx xx xx xx HC LC 
**Tsimen-2000 端返回值：** 设置成功 01 52 49 96 DC ； 设置失败 01 46 41 50 D2 ； CRC校验失败 01 43 52 43 45 52 04 16

**响应时间：** 30 ms  

#### Ⅳ. 查询光谱仪当前积分时间

**上位机发送：** 01 04 00 00 00 00 0A F0  
**Tsimen-2000 端返回值：** <font color='red'>积分时间（待定）</font>  
**响应时间：** 30 ms

#### Ⅴ. 设置光谱仪平均次数

**上位机发送：** 01 05 xx xx xx xx HC LC 
**Tsimen-2000 端返回值：** 设置成功 01 52 49 96 DC ； 设置失败 01 46 41 50 D2 ； CRC校验失败 01 43 52 43 45 52 04 16
**响应时间：** 30 ms

#### Ⅵ. 查询光谱仪当前平均次数

**上位机发送：** 01 06 00 00 00 00 CA 89  
**Tsimen-2000 端返回值：** <font color='red'>平均次数</font>  
**响应时间：** 30 ms

#### Ⅶ. 读取暗电流条件下光谱仪数据

**上位机发送：** 01 07 00 00 00 00 0A B4  
**Tsimen-2000 端返回值：** <font color='red'>暗信号数据</font>  
**响应时间：** 2500 ms

#### Ⅷ. 读取参考信号条件下光谱仪数据

**上位机发送：** 01 08 00 00 00 00 0B E0  
**Tsimen-2000 端返回值：** <font color='red'>参考信号数据</font>  
**响应时间：** 2500 ms

#### Ⅸ. 读取样品信号条件下光谱仪数据

**上位机发送：** 01 09 00 00 00 00 CB DD  
**Tsimen-2000 端返回值：** <font color='red'>样品信号数据</font>  
**响应时间：** 2500 ms

#### Ⅹ. 一键获取暗、参、样光谱仪数据

**上位机发送：** 01 0A 00 00 00 00 CB 99  
**Tsimen-2000 端返回值：** <font color='red'>三种信号数据</font>  
**响应时间：** 10000 ms

#### ⅩⅠ. 读取外置传感器温度湿度、片内传感器温度

**上位机发送：** 01 0B 00 00 00 00 0B A4  
**Tsimen-2000 端返回值：** 24.3459.4343.32  {5字节传感器温度数据+5字节传感器湿度数据+5字节板内温度数据}    
**响应时间：** 30 ms

### 2. 电动刷机端   

电动刷机用于清洁 Tsimen-2000 传感器镜头，以避免油污、泥沙等杂质遮挡光路。

#### Ⅰ. 驱动舵机清洁镜头

**上位机发送：** 02 01 00 00 00 00 39 3C 
**电动刷机端返回值：** 设置成功 01 52 49 96 DC ； 设置失败 01 46 41 50 D2 ； CRC校验失败 01 43 52 43 45 52 04 16
**响应时间：** 30 ms

    










## 三、附录

### 附录1 CRC校验代码

    /**
    * @brief CRC16 check code. The function is used for data verification when communicating with PC.
    *  
    * @param pdata 
    * @param len 
    * @return uint16_t 
    */
    uint16_t ModBus_CRC16( uint8_t *pdata, int len)     //polynomial: 8005
    {
    crc = 0xFFFF;
    for ( CRC_j=0; CRC_j<len;CRC_j++)
    {
        crc=crc^pdata[CRC_j];
        for ( CRC_i=0; CRC_i<8; CRC_i++)
        {
        if( ( crc&0x0001) >0)
        {
            crc=crc>>1;
            crc=crc^ 0xA001;                            //We take 8005 in reverse.
        }
        else
        crc=crc>>1;
        }
    }
    return crc;
    }















